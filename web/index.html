<!doctype html>
<html lang="en">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">
<style>
  .game-viewport {
    width: 1280px;
    height: 720px;
  }

  div.game-viewport {
    background: #2b2e36;
  }
</style>
<body>
<script type="module">
  document.addEventListener('DOMContentLoaded', async function () {
    const configureBtn = document.querySelector("#configure-btn");
    const configurationModal = document.querySelector("#configuration-modal");
    const helpModal = document.querySelector('#help-modal');
    const helpBtn = document.querySelector("#help-btn");
    const saveBtn = document.querySelector("#save-btn");
    const startGameBtn = document.querySelector('#start-game-btn');
    const gameVersionSpan = document.querySelector('#game-version');

    configureBtn.addEventListener('click', function (event) {
      configurationModal.classList.add("is-active");
    });

    helpBtn.addEventListener('click', function (event) {
      helpModal.classList.add("is-active");
    });

    const allModals = document.querySelectorAll(".modal");

    allModals.forEach(function (modal) {
      modal.querySelector('button[aria-label="close"]').addEventListener('click', function (event) {
        modal.classList.remove('is-active');
      });
    });

    const response = await fetch('https://api.github.com/repos/lunfel/voxel/releases/latest')

    if (!response.ok) {
      throw new Error(`Response status: ${response.status}`)
    }

    let data = await response.json();

    let gameJs = data.assets.find(asset => asset.name.endsWith('.js'));
    let gameWasm = data.assets.find(asset => asset.name.endsWith('.wasm'));

    startGameBtn.addEventListener('click', async function (event) {
      const toggleOff = document.querySelector('.game-viewport:not(.is-hidden)')
      const toggleOn = document.querySelector('.game-viewport.is-hidden');

      toggleOff.classList.add('is-hidden');
      toggleOn.classList.remove('is-hidden');

      const voxel_module = await import(gameJs.browser_download_url);

      const init = await voxel_module.default();
      const set_form_value = voxel_module.set_form_value;

      saveBtn.addEventListener('click', function (event) {
        const modal = event.target.closest('.modal')

        const seedValue = parseInt(document.querySelector('#input-seed').value);
        const octavesValue = parseInt(document.querySelector('#input-octaves').value)
        const frequencyValue = parseFloat(document.querySelector('#input-frequency').value)
        const amplitudeValue = parseFloat(document.querySelector('#input-amplitude').value)
        const lacunarityValue = parseFloat(document.querySelector('#input-lacunarity').value)
        const gainValue = parseFloat(document.querySelector('#input-gain').value)

        set_form_value(seedValue, octavesValue, frequencyValue, amplitudeValue, lacunarityValue, gainValue)

        modal.classList.remove('is-active')
      });

      init(gameWasm.browser_download_url).catch((error) => {
        if (!error.message.startsWith("Using exceptions for control flow, don't mind me. This isn't actually an error!")) {
          throw error;
        }
      })
    });

    gameVersionSpan.innerText = data.tag_name;

    console.log('gamejs', gameJs);
    console.log('gameWasm', gameWasm);

    const wasmSizeMB = (gameWasm.size / 1024 / 1024).toFixed(0);

    startGameBtn.innerText = `Start Game (${wasmSizeMB}MB)`
  }, false);
</script>

<section class="section">
  <div class="container">
    <div class="block">
      <div class="game-viewport">
        <div class="columns has-text-centered is-vcentered" style="height: 100%">
          <div class="column is-12">
            <button id="start-game-btn" class="button">Start Game</button>
          </div>
        </div>
      </div>
      <canvas id="bevy-canvas" class="game-viewport is-hidden"></canvas>
    </div>

    <div class="block">
      <div class="buttons">
        <button id="configure-btn" class="button">Configure</button>
        <button id="help-btn" class="button">Help</button>
      </div>
    </div>
  </div>
</section>

<div id="configuration-modal" class="modal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">Configure terrain generation</p>
      <button class="delete" aria-label="close"></button>
    </header>
    <section class="modal-card-body">
      <div class="columns">
        <div class="column">
          <div class="field">
            <label class="label">Seed Number</label>
            <div class="control">
              <input id="input-seed" class="input" type="number" placeholder="Enter the seed number" value="4" min="0" max="4294967295">
            </div>
            <p class="help">The seed value for the noise generator. Changing the seed results in a different randomized terrain.</p>
            <p class="help">Range: [0, 4294967295]</p>
          </div>

          <div class="field">
            <label class="label">Frequency</label>
            <div class="control">
              <input id="input-frequency" class="input" type="number" placeholder="Enter the seed number" value="100" min="1" max="100000">
            </div>
            <p class="help">
              This value is actually the period (1 divided by frequency). Smaller values create jagged, peak-heavy terrain, while larger values create broader, smoother, plains-like landscapes.
            </p>
            <p class="help">Range: [1, 100000]</p>
          </div>

          <div class="field">
            <label class="label">Lacunarity</label>
            <div class="control">
              <input id="input-lacunarity" class="input" type="number" placeholder="Enter the seed number" value="2.1" min="0" max="8">
            </div>
            <p class="help">Lacunarity determines how quickly the terrain details increase with each octave.</p>
            <p class="help">Range: [0, 8]</p>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">Number of octaves</label>
            <div class="control">
              <input id="input-octaves" class="input" type="number" placeholder="Enter the seed number" value="3" min="1" max="3">
            </div>
            <p class="help">Using more octaves creates terrain with richer details and a more varied appearance.</p>
            <p class="help">Range: [1, 3]</p>
          </div>

          <div class="field">
            <label class="label">Amplitude</label>
            <div class="control">
              <input id="input-amplitude" class="input" type="number" placeholder="Enter the seed number" value="80" min="1" max="200">
            </div>
            <p class="help">Amplitude controls the height of the terrain. Higher values make peaks taller and valleys deeper, while lower values create flatter terrain.</p>
            <p class="help">
              Range: [1, 200]
            </p>
          </div>

          <div class="field">
            <label class="label">Gain</label>
            <div class="control">
              <input id="input-gain" class="input" type="number" placeholder="Enter the seed number" value="0.6" min="0" max="8">
            </div>
            <p class="help">Gain controls how much each successive octave contributes to the terrain. Higher values make smaller details more pronounced, while lower values soften them.</p>
            <p class="help">Range: [0, 8]</p>
          </div>
        </div>
      </div>
    </section>
    <footer class="modal-card-foot">
      <div class="buttons">
        <button id="save-btn" class="button is-success">Save changes</button>
      </div>
    </footer>
  </div>
</div>
<div id="help-modal" class="modal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">Help</p>
      <button class="delete" aria-label="close"></button>
    </header>
    <section class="modal-card-body">
      <div class="block">
        <p>Controls</p>

        <ul>
          <li>W / A / S / D &#8594; Move forward, left, backward, right</li>
          <li>Spacebar &#8594; Move upward</li>
          <li>C &#8594; Move downward</li>
          <li>Mouse &#8594; Look around / aim</li>
          <li>Esc &#8594; Release mouse cursor</li>
        </ul>
      </div>

      <article class="message is-warning">
        <div class="message-body">
          Because the game is running in a web page, performance is not as smooth as a regular program. You can still play and enjoy it!
        </div>
      </article>

      <div class="block">
        <p>Game Version <span id="game-version">??</span></p>
        <a href="https://github.com/lunfel/voxel">Source</a>
      </div>
    </section>
  </div>
</div>
</body>

</html>